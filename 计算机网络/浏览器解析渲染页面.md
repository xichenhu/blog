## 浏览器内核拿到内容后，渲染步骤大致可以分为以下几步：

1. 解析HTML，构建DOM树

2. 解析CSS，生成CSS规则树

3. 合并DOM树和CSS规则，生成render树

4. 布局render树（Layout/reflow），负责各元素尺寸、位置的计算

5. 绘制render树（paint），绘制页面像素信息

6. 浏览器会将各层的信息发送给GPU，GPU会将各层合成（composite），显示在屏幕上

> PS:  
reflow：也称作layout，中文叫回流，一般意味着元素的内容、结构、位置或尺寸发生了变化，需要重新计算样式和渲染树，这个过程称为reflow。  
> 
> repaint：中文重绘，意味着元素发生的改变只是影响了元素的一些外观之类的时候(例如：背景色，边框颜色，文字颜色等)，此时只需要应用新样式绘制这个元素就可以了。


### 一、根据 HTML 解析 DOM 树
这种说法基本正确，但有一些细节需要补充和澄清。以下是详细分析：

---

#### 1. **HTML 解析与 DOM 树构建**
- **DOM 树的构建**：
  - 浏览器解析 HTML 文档时，会按照 HTML 的内容和结构逐步构建 DOM 树。
  - DOM 树的构建过程是一个**深度优先遍历**的过程。也就是说，浏览器会先构建当前节点的所有子节点，然后再构建下一个兄弟节点。
  - 例如：
    ```html
    <div>
        <p>Hello</p>
        <span>World</span>
    </div>
    ```
    浏览器会先构建 `<div>` 节点，然后构建其子节点 `<p>`，接着构建 `<p>` 的子节点（文本节点 `"Hello"`），然后再回到 `<div>` 构建下一个子节点 `<span>`，最后构建 `<span>` 的子节点（文本节点 `"World"`）。

---

#### 2. **遇到 `<script>` 标签时的行为**
- **默认行为**：
  - 当浏览器在解析 HTML 时遇到 `<script>` 标签，**DOM 树的构建会暂停**，直到脚本下载（如果是外部脚本）并执行完毕。
  - 这是因为 JavaScript 可能会通过 `document.write` 修改 DOM 结构，或者访问和操作 DOM 节点。为了保证 DOM 的正确性，浏览器必须暂停 DOM 树的构建，直到脚本执行完成。
  - 例如：
    ```html
    <div>
        <p>Hello</p>
        <script>
            console.log(document.querySelector('p').textContent); // 输出 "Hello"
        </script>
        <span>World</span>
    </div>
    ```
    在这个例子中，浏览器会先构建 `<div>` 和 `<p>` 节点，然后遇到 `<script>` 标签时暂停 DOM 树的构建，执行脚本，最后再继续构建 `<span>` 节点。

- **异步脚本**：
  - 如果 `<script>` 标签带有 `async` 或 `defer` 属性，浏览器的行为会有所不同：
    - **`async`**：脚本会异步下载，下载完成后立即执行。此时 DOM 树的构建可能会被暂停，具体取决于脚本下载完成的时间。
    - **`defer`**：脚本会异步下载，但会延迟到 DOM 树构建完成后再执行。此时 DOM 树的构建不会被暂停。

---

#### 3. **其他注意事项**
- **CSS 对 DOM 构建的影响**：
  - CSS 的加载和解析不会直接阻塞 DOM 树的构建，但会阻塞渲染（即生成渲染树的过程）。
  - 如果 JavaScript 试图访问某些依赖于 CSSOM 的样式属性，浏览器会等待 CSSOM 构建完成后再执行脚本。

- **现代浏览器的预解析优化**：
  - 现代浏览器会通过**预解析器**（Preload Scanner）提前扫描 HTML 文档，预加载外部资源（如脚本、样式表、图片等），以减少阻塞时间。
  - 这意味着即使 DOM 树的构建被 `<script>` 标签阻塞，浏览器仍可以在后台下载其他资源。

---

### 二、根据 CSS 解析生成 CSS 规则树
1. **CSS 解析与 CSSOM 构建**：
   - 浏览器在解析 HTML 时遇到 `<link>` 或 `<style>` 标签时，会开始下载并解析 CSS 文件。
   - 解析 CSS 会生成 CSSOM（CSS Object Model），即 CSS 规则树。
   - CSSOM 的构建是逐步进行的，浏览器会一边解析 CSS 一边构建 CSSOM。

2. **CSS 解析与 JavaScript 执行**：
   - JavaScript 的执行可能会被 CSS 解析阻塞，但并非总是如此。
   - 如果 JavaScript 试图访问某些依赖于 CSSOM 的样式属性（例如 `element.style` 或 `getComputedStyle`），浏览器会等待 CSSOM 构建完成后再执行这些 JavaScript 代码。
   - 如果 JavaScript 不依赖于 CSSOM，浏览器可以在 CSS 解析的同时执行 JavaScript。

3. **渲染阻塞**：
   - 浏览器在构建完 DOM 和 CSSOM 之前不会进行渲染。
   - 如果 CSS 文件较大或加载较慢，渲染确实会被阻塞，直到 CSSOM 构建完成。
   - 这种阻塞是为了避免“无样式内容的闪烁”（FOUC，Flash of Unstyled Content）。

4. **现代浏览器的优化**：
   - 现代浏览器会尝试并行处理 CSS 解析和 JavaScript 执行，以提高性能。
   - 浏览器可能会对 JavaScript 的执行进行重新排序，以避免不必要的阻塞。

### 三、结合 DOM 树和 CSS 规则树，生成渲染树

#### 1. **渲染树的生成**
- **渲染树（Render Tree）**：
  - 渲染树是 DOM 树和 CSSOM（CSS 规则树）的结合体。它只包含需要渲染的节点（即视觉上可见的节点），例如 `display: none` 的元素不会包含在渲染树中。
  - 渲染树的构建过程如下：
    1. 从 DOM 树的根节点开始遍历。
    2. 对于每个可见节点，找到匹配的 CSS 规则，并将这些规则应用到节点上。
    3. 将节点及其样式信息添加到渲染树中。

- **渲染树的构建时机**：
  - 浏览器确实需要 **DOM 树和 CSSOM 都准备好** 之后才会开始构建渲染树。
  - 如果 DOM 树或 CSSOM 尚未完全构建完成，浏览器会等待它们就绪后再生成渲染树。

---

#### 2. **CSS 规则树的构建与优化**
- **CSS 规则树的构建**：
  - CSS 规则树（CSSOM）的构建是逐步进行的。浏览器会一边解析 CSS 文件，一边构建 CSSOM。
  - 如果 CSS 文件较大或解析较慢，CSSOM 的构建会延迟，从而影响渲染树的生成和页面的渲染。

- **精简 CSS 的作用**：
  - 精简 CSS（例如删除无用代码、压缩文件大小、减少选择器复杂度等）可以 **加快 CSS 文件的下载和解析速度**，从而加快 CSSOM 的构建。
  - 更快的 CSSOM 构建意味着渲染树可以更快生成，进而加快页面的渲染速度。

---

#### 3. **注意事项**
- **渲染阻塞**：
  - CSS 是 **渲染阻塞资源**。即使 DOM 树已经构建完成，浏览器也需要等待 CSSOM 构建完成后才能生成渲染树。
  - 因此，优化 CSS 的加载和解析对页面性能至关重要。

- **JavaScript 的影响**：
  - 如果 JavaScript 试图访问某些依赖于 CSSOM 的样式属性（例如 `element.style` 或 `getComputedStyle`），浏览器会等待 CSSOM 构建完成后再执行这些 JavaScript 代码。
  - 这种情况下，CSS 的加载和解析不仅影响渲染树的生成，还可能间接阻塞 JavaScript 的执行。

- **现代浏览器的优化**：
  - 现代浏览器会通过 **预加载扫描器（Preload Scanner）** 提前下载 CSS 文件，以减少阻塞时间。
  - 使用 `media` 属性或 `preload` 提示可以进一步优化 CSS 的加载行为。
